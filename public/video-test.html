<!doctype html>
<meta charset="utf-8">
<title>ëœë¤ ì˜ìƒ í†µí™” í…ŒìŠ¤íŠ¸</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .container { max-width: 1200px; margin: 0 auto; }
  .controls { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; }
  .controls button { margin: 5px; padding: 10px 15px; cursor: pointer; }
  .video-container { display: flex; gap: 20px; margin: 20px 0; }
  .video-box { flex: 1; position: relative; }
  video { width: 100%; max-width: 500px; border: 2px solid #ddd; border-radius: 8px; background: #000; }
  .local-video { transform: scaleX(-1); } /* ê±°ìš¸ ëª¨ë“œ */
  .compatibility-overlay { 
    position: absolute; 
    top: 10px; 
    left: 10px; 
    background: rgba(0,0,0,0.8); 
    color: white; 
    padding: 15px; 
    border-radius: 8px; 
    min-width: 200px;
    z-index: 10;
  }
  .compatibility-overlay.hidden { display: none; }
  .compatibility-score { font-size: 24px; font-weight: bold; color: #4CAF50; }
  .compatibility-verdict { margin-top: 10px; font-size: 14px; }
  .log-container { 
    height: 300px; 
    overflow: auto; 
    border: 1px solid #ccc; 
    padding: 10px; 
    background: #fafafa; 
    font-family: monospace; 
    font-size: 12px;
  }
  input[type="text"] { padding: 8px; width: 400px; margin: 5px; }
  .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
  .status.waiting { background: #fff3cd; }
  .status.matched { background: #d4edda; }
  .status.connected { background: #d1ecf1; }
  .status.disconnected { background: #f8d7da; }
</style>
<body>
  <div class="container">
    <h1>ëœë¤ ì˜ìƒ í†µí™” í…ŒìŠ¤íŠ¸</h1>
    
    <div class="controls">
      <div>
        <input id="token" type="text" placeholder="JWT í† í° ì…ë ¥" style="width: 400px;" />
        <button id="loadToken" style="background: #6c757d;">í† í° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="connect">ì—°ê²°</button>
        <button id="disconnect">ì—°ê²° í•´ì œ</button>
      </div>
      <div style="margin-top: 10px;">
        <button id="join">ëœë¤ ì˜ìƒ ë§¤ì¹­ ì‹œì‘</button>
        <button id="end">í†µí™” ì¢…ë£Œ</button>
        <button id="toggleCompatibility">ê¶í•©ë„ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°</button>
        <button id="report">ì‹ ê³ </button>
      </div>
      <div id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
    </div>

    <div class="video-container">
      <div class="video-box">
        <h3>ìƒëŒ€ë°© (ì›ê²©)</h3>
        <video id="remoteVideo" autoplay playsinline></video>
        <div id="compatibilityOverlay" class="compatibility-overlay">
          <div class="compatibility-score" id="compatibilityScore">-</div>
          <div class="compatibility-verdict" id="compatibilityVerdict">ë§¤ì¹­ ëŒ€ê¸° ì¤‘...</div>
          <button onclick="toggleCompatibility()" style="margin-top: 10px; padding: 5px 10px;">ìˆ¨ê¸°ê¸°</button>
        </div>
      </div>
      <div class="video-box">
        <h3>ë‚˜ (ë¡œì»¬)</h3>
        <video id="localVideo" class="local-video" autoplay playsinline muted></video>
      </div>
    </div>

    <div id="reportBox" style="display:none; margin-top:20px; padding:15px; background:#fff3cd; border-radius:8px;">
      <h4>ì‹ ê³  ì‘ì„±</h4>
      <input id="reason" type="text" placeholder="ì‹ ê³  ì‚¬ìœ  ì…ë ¥" style="width: 500px;" />
      <button id="reportSubmit">ì‹ ê³  ì œì¶œ</button>
      <button id="reportCancel">ì·¨ì†Œ</button>
    </div>

    <h3>ë¡œê·¸</h3>
    <div id="log" class="log-container"></div>
  </div>

<script>
// í˜„ì¬ ì ‘ì†í•œ URL ìë™ ê°ì§€ (ngrok URLë„ ìë™ìœ¼ë¡œ ì‚¬ìš©)
const SERVER_URL = window.location.origin;

let socket = null;
let peer = null;
let localStream = null;
let roomId = null;
let partnerId = null;
let compatibility = null;
let compatibilityVisible = true;
let pendingSignals = []; // peer ìƒì„± ì „ ì‹œê·¸ë„ë§ ë°ì´í„° ì €ì¥

const log = (msg) => {
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  el.textContent += `[${time}] ${msg}\n`;
  el.scrollTop = el.scrollHeight;
  console.log(msg);
};

const updateStatus = (text, className) => {
  const statusEl = document.getElementById('status');
  statusEl.textContent = text;
  statusEl.className = `status ${className}`;
};

// í† í° ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('loadToken').onclick = () => {
  const savedToken = localStorage.getItem('accessToken');
  if (savedToken) {
    document.getElementById('token').value = savedToken;
    log('âœ… í† í°ì„ localStorageì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
  } else {
    alert('ì €ì¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì†Œì…œ ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.');
    log('âš ï¸ localStorageì— í† í°ì´ ì—†ìŠµë‹ˆë‹¤');
  }
};

// Socket ì—°ê²°
document.getElementById('connect').onclick = async () => {
  let token = document.getElementById('token').value.trim();
  
  // í† í°ì´ ì—†ìœ¼ë©´ localStorageì—ì„œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
  if (!token) {
    token = localStorage.getItem('accessToken');
    if (token) {
      document.getElementById('token').value = token;
      log('âœ… localStorageì—ì„œ í† í°ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
    } else {
      alert('JWT í† í°ì„ ì…ë ¥í•˜ê±°ë‚˜, ë¨¼ì € ì†Œì…œ ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.');
      return;
    }
  }

  socket = io(SERVER_URL, { auth: { token } });

  socket.on("connect", () => {
    log("âœ… Socket ì—°ê²°ë¨: " + socket.id);
    updateStatus("ì—°ê²°ë¨", "connected");
  });

  socket.on("connect_error", (err) => {
    log("âŒ ì—°ê²° ì˜¤ë¥˜: " + (err?.message || err));
    updateStatus("ì—°ê²° ì‹¤íŒ¨", "disconnected");
  });

  socket.on("disconnect", (reason) => {
    log("ğŸ”Œ ì—°ê²° í•´ì œ: " + reason);
    updateStatus("ì—°ê²° í•´ì œë¨", "disconnected");
  });

  socket.on("queue:waiting", ({ position, type }) => {
    log(`â³ ëŒ€ê¸° ì¤‘... ìœ„ì¹˜: ${position}, íƒ€ì…: ${type}`);
    updateStatus(`ëŒ€ê¸° ì¤‘... (ìœ„ì¹˜: ${position})`, "waiting");
  });

  socket.on("match:found", async (data) => {
    roomId = data.roomId;
    partnerId = data.partnerId;
    compatibility = data.compatibility;
    compatibilityVisible = data.compatibilityVisible !== false;
    const isInitiator = data.isInitiator || false;

    log(`ğŸ¯ ë§¤ì¹­ ì„±ê³µ! ë°©: ${roomId}, ìƒëŒ€: ${partnerId}`);
    log(`ğŸ“Š ê¶í•©ë„: ${compatibility?.score ?? 'N/A'}%`);
    log(`ğŸ”§ Initiator: ${isInitiator ? 'ë‚˜' : 'ìƒëŒ€ë°©'}`);
    updateStatus("ë§¤ì¹­ë¨ - ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ëŒ€ê¸° ì¤‘...", "matched");

    // ê¶í•©ë„ í‘œì‹œ
    updateCompatibilityDisplay();

    // ì‚¬ìš©ìì—ê²Œ ê¶Œí•œ ìš”ì²­ ì•ˆë‚´
    const proceed = confirm("ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n\nê¶Œí•œì„ í—ˆìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ë¸Œë¼ìš°ì €ì—ì„œ ê¶Œí•œ ìš”ì²­ íŒì—…ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤)");
    if (!proceed) {
      log("âš ï¸ ì‚¬ìš©ìê°€ ê¶Œí•œ ìš”ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤");
      updateStatus("ê¶Œí•œ ìš”ì²­ ì·¨ì†Œë¨", "disconnected");
      return;
    }

    // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° ë° WebRTC ì´ˆê¸°í™”
    await initializeWebRTC(isInitiator);
  });

  socket.on("video:ended", ({ reason }) => {
    log(`ğŸ”š í†µí™” ì¢…ë£Œ: ${reason}`);
    cleanup();
    updateStatus("í†µí™” ì¢…ë£Œë¨", "disconnected");
  });

  // WebRTC ì‹œê·¸ë„ë§ ì´ë²¤íŠ¸
  socket.on("webrtc:offer", ({ offer }) => {
    log("ğŸ“¨ Offer ìˆ˜ì‹ ");
    if (peer) {
      peer.signal(offer);
    } else {
      log("â³ Peer ìƒì„± ëŒ€ê¸° ì¤‘... Offer ì €ì¥");
      pendingSignals.push(offer);
    }
  });

  socket.on("webrtc:answer", ({ answer }) => {
    log("ğŸ“¨ Answer ìˆ˜ì‹ ");
    if (peer) {
      peer.signal(answer);
    } else {
      log("â³ Peer ìƒì„± ëŒ€ê¸° ì¤‘... Answer ì €ì¥");
      pendingSignals.push(answer);
    }
  });

  socket.on("webrtc:ice-candidate", ({ candidate }) => {
    log("ğŸ“¨ ICE Candidate ìˆ˜ì‹ ");
    if (peer) {
      peer.signal(candidate);
    } else {
      log("â³ Peer ìƒì„± ëŒ€ê¸° ì¤‘... ICE Candidate ì €ì¥");
      pendingSignals.push(candidate);
    }
  });

  // ê¶í•©ë„ í‘œì‹œ/ìˆ¨ê¹€
  socket.on("compatibility:visibility", ({ visible }) => {
    compatibilityVisible = visible;
    updateCompatibilityDisplay();
    log(`ğŸ‘ï¸ ê¶í•©ë„ í‘œì‹œ: ${visible ? 'ë³´ì„' : 'ìˆ¨ê¹€'}`);
  });

  // ì‹ ê³  ê²°ê³¼
  socket.on("user:reported", (result) => {
    if (result?.ok) {
      log("âœ… ì‹ ê³  ì™„ë£Œ");
      document.getElementById('reportBox').style.display = 'none';
    } else {
      log("âŒ ì‹ ê³  ì‹¤íŒ¨: " + (result?.error || "unknown"));
    }
  });
};

// ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° ë° WebRTC ì´ˆê¸°í™”
async function initializeWebRTC(isInitiator = false) {
  try {
    // HTTPS í™•ì¸ (ì¹´ë©”ë¼ ì ‘ê·¼ì„ ìœ„í•´ í•„ìš”)
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      log("âš ï¸ HTTPSê°€ í•„ìš”í•©ë‹ˆë‹¤. ngrok URLì„ ì‚¬ìš©í•˜ì„¸ìš”.");
      alert("ì¹´ë©”ë¼ ì ‘ê·¼ì„ ìœ„í•´ HTTPSê°€ í•„ìš”í•©ë‹ˆë‹¤.\nngrok URL(https://...)ì„ ì‚¬ìš©í•˜ì„¸ìš”.");
      return;
    }

    // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
    log("ğŸ“¹ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ìš”ì²­ ì¤‘...");
    log("ğŸ’¡ ë¸Œë¼ìš°ì €ì—ì„œ ê¶Œí•œ ìš”ì²­ íŒì—…ì´ ë‚˜íƒ€ë‚˜ë©´ 'í—ˆìš©'ì„ í´ë¦­í•˜ì„¸ìš”");
    updateStatus("ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì¤‘...", "matched");
    
    try {
      localStream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: 'user'
        },
        audio: {
          echoCancellation: true,
          noiseSuppression: true
        }
      });
    } catch (err) {
      log("âŒ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜: " + err.name + " - " + err.message);
      let errorMsg = "";
      
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        errorMsg = "ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n";
        errorMsg += "1. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ ìë¬¼ì‡  ì•„ì´ì½˜ í´ë¦­\n";
        errorMsg += "2. 'ì‚¬ì´íŠ¸ ì„¤ì •' ë˜ëŠ” 'ê¶Œí•œ' í´ë¦­\n";
        errorMsg += "3. ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ë¥¼ 'í—ˆìš©'ìœ¼ë¡œ ë³€ê²½\n";
        errorMsg += "4. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„\n\n";
        errorMsg += "ë˜ëŠ” ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì§ì ‘ ê¶Œí•œì„ í—ˆìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        alert(errorMsg);
      } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
        errorMsg = "ì¹´ë©”ë¼/ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nê¸°ê¸°ì— ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
        alert(errorMsg);
      } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
        errorMsg = "ì¹´ë©”ë¼/ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼/ë§ˆì´í¬ë¥¼ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ì•±ì„ ì¢…ë£Œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
        alert(errorMsg);
      } else {
        errorMsg = "ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜: " + err.message + "\n\nì˜¤ë¥˜ íƒ€ì…: " + err.name;
        alert(errorMsg);
      }
      updateStatus("ê¶Œí•œ ì˜¤ë¥˜", "disconnected");
      throw err;
    }

    const localVideo = document.getElementById('localVideo');
    localVideo.srcObject = localStream;
    log("âœ… ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ íšë“ ì„±ê³µ");

    // Simple-Peer ìƒì„±
    peer = new SimplePeer({
      initiator: isInitiator,
      trickle: false,
      stream: localStream,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' },
          // ë¬´ë£Œ TURN ì„œë²„ ì¶”ê°€ (ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹œ í•„ìš”)
          {
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
          },
          {
            urls: 'turn:openrelay.metered.ca:443',
            username: 'openrelayproject',
            credential: 'openrelayproject'
          }
        ]
      }
    });

    // ì‹œê·¸ë„ë§ ë°ì´í„° ì „ì†¡
    peer.on('signal', (data) => {
      if (!roomId) return;

      if (data.type === 'offer') {
        log("ğŸ“¤ Offer ì „ì†¡");
        socket.emit("webrtc:offer", { roomId, offer: data });
      } else if (data.type === 'answer') {
        log("ğŸ“¤ Answer ì „ì†¡");
        socket.emit("webrtc:answer", { roomId, answer: data });
      } else {
        // ICE Candidate
        socket.emit("webrtc:ice-candidate", { roomId, candidate: data });
      }
    });

    // ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ 
    peer.on('stream', (stream) => {
      log("âœ… ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì„±ê³µ!");
      const remoteVideo = document.getElementById('remoteVideo');
      remoteVideo.srcObject = stream;
      remoteVideo.onloadedmetadata = () => {
        log("ğŸ“¹ ì›ê²© ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
        remoteVideo.play().catch(err => {
          log("âš ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜: " + err.message);
        });
      };
      updateStatus("í†µí™” ì—°ê²°ë¨", "connected");
    });

    // ICE ì—°ê²° ìƒíƒœ ì¶”ì 
    peer.on('iceStateChange', (state) => {
      log(`ğŸ§Š ICE ìƒíƒœ ë³€ê²½: ${state}`);
      if (state === 'failed' || state === 'disconnected') {
        log("âš ï¸ ICE ì—°ê²° ì‹¤íŒ¨ - NAT/ë°©í™”ë²½ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤");
        updateStatus("ì—°ê²° ì‹¤íŒ¨ - ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ", "disconnected");
      }
    });

    // ëŒ€ê¸° ì¤‘ì¸ ì‹œê·¸ë„ë§ ë°ì´í„° ì²˜ë¦¬
    if (pendingSignals.length > 0) {
      log(`ğŸ“¨ ëŒ€ê¸° ì¤‘ì¸ ì‹œê·¸ë„ë§ ë°ì´í„° ${pendingSignals.length}ê°œ ì²˜ë¦¬ ì¤‘...`);
      pendingSignals.forEach(signal => {
        peer.signal(signal);
      });
      pendingSignals = [];
    }

    // ì—°ê²° ìƒíƒœ
    peer.on('connect', () => {
      log("ğŸ”— WebRTC ì—°ê²° ì™„ë£Œ!");
      updateStatus("í†µí™” ì¤‘", "connected");
    });

    peer.on('close', () => {
      log("ğŸ”Œ WebRTC ì—°ê²° ì¢…ë£Œ");
      cleanup();
    });

    peer.on('error', (err) => {
      log("âŒ WebRTC ì˜¤ë¥˜: " + err.message);
      log("âŒ ì˜¤ë¥˜ ìƒì„¸: " + JSON.stringify(err));
      updateStatus("ì—°ê²° ì˜¤ë¥˜ ë°œìƒ", "disconnected");
    });

  } catch (err) {
    log("âŒ WebRTC ì´ˆê¸°í™” ì‹¤íŒ¨: " + err.message);
    log("âŒ ì˜¤ë¥˜ íƒ€ì…: " + err.name);
    updateStatus("ì—°ê²° ì‹¤íŒ¨", "disconnected");
  }
}

// ì •ë¦¬ í•¨ìˆ˜
function cleanup() {
  if (peer) {
    peer.destroy();
    peer = null;
  }
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  roomId = null;
  partnerId = null;
  pendingSignals = []; // ëŒ€ê¸° ì¤‘ì¸ ì‹œê·¸ë„ë§ ë°ì´í„° ì´ˆê¸°í™”
}

// ê¶í•©ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateCompatibilityDisplay() {
  const overlay = document.getElementById('compatibilityOverlay');
  const scoreEl = document.getElementById('compatibilityScore');
  const verdictEl = document.getElementById('compatibilityVerdict');

  if (compatibility && compatibilityVisible) {
    overlay.classList.remove('hidden');
    scoreEl.textContent = compatibility.score !== null ? `${compatibility.score}%` : 'N/A';
    verdictEl.textContent = compatibility.verdict || 'ê¶í•©ë„ ì •ë³´ ì—†ìŒ';
  } else {
    overlay.classList.add('hidden');
  }
}

// ê¶í•©ë„ í† ê¸€
function toggleCompatibility() {
  if (!roomId) return;
  compatibilityVisible = !compatibilityVisible;
  socket.emit("compatibility:toggle", { roomId, visible: compatibilityVisible }, (ack) => {
    if (ack?.ok) {
      updateCompatibilityDisplay();
    }
  });
}

// ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('disconnect').onclick = () => {
  if (socket) {
    socket.disconnect();
    socket = null;
  }
  cleanup();
  updateStatus("ì—°ê²° í•´ì œë¨", "disconnected");
};

document.getElementById('join').onclick = () => {
  if (!socket || !socket.connected) {
    alert('ë¨¼ì € Socketì— ì—°ê²°í•˜ì„¸ìš”');
    return;
  }
  log("ğŸš€ ì˜ìƒ í†µí™” ë§¤ì¹­ ì‹œì‘");
  socket.emit("queue:join", { type: 'video' });
};

document.getElementById('end').onclick = () => {
  if (!roomId) {
    log("âš ï¸ í™œì„± í†µí™”ê°€ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  socket.emit("chat:end", { roomId, reason: "user_ended" }, (ack) => {
    log("ì¢…ë£Œ ìš”ì²­: " + JSON.stringify(ack));
  });
};

document.getElementById('toggleCompatibility').onclick = toggleCompatibility;

document.getElementById('report').onclick = () => {
  document.getElementById('reportBox').style.display = 'block';
};

document.getElementById('reportCancel').onclick = () => {
  document.getElementById('reportBox').style.display = 'none';
};

document.getElementById('reportSubmit').onclick = () => {
  const reason = document.getElementById('reason').value.trim();
  if (!reason) {
    log("âš ï¸ ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }
  if (!roomId) {
    log("âš ï¸ í™œì„± í†µí™”ê°€ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  socket.emit("user:report", { roomId, reason });
  document.getElementById('reason').value = '';
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
window.onload = () => {
  const savedToken = localStorage.getItem('accessToken');
  if (savedToken) {
    document.getElementById('token').value = savedToken;
    log('âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ í† í°ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
    log('ğŸ’¡ "ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ Socketì— ì—°ê²°í•˜ì„¸ìš”');
  } else {
    log('ğŸ’¡ í† í° í™•ì¸ ë°©ë²•:\n1. ì†Œì…œ ë¡œê·¸ì¸ í›„ auth-callback.htmlì—ì„œ í† í° í™•ì¸\n2. "í† í° ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ í´ë¦­\n3. ë˜ëŠ” auth-test.htmlì—ì„œ ë¡œê·¸ì¸ í›„ í† í° ë³µì‚¬');
  }
};
</script>
</body>

